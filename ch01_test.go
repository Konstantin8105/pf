package pf

import (
	"fmt"
	"math"

	"github.com/Konstantin8105/pow"
)

func Example() {
	var (
		//	#Problem dimensions
		b = 10. // #m
		h = 0.5 // #m

		//	#Material parameters
		k   = 1000. // #N/m
		EA0 = 5e6   // #N/m^2

		//	#External load increment
		DF = 50.0 // #N

		// #Solver parameters
		N       = 30
		tol     = 1e-6
		iterMax = 5

		//	#Some useful functions
		//	from math import sqrt

		l = func(v float64) float64 {
			return math.Sqrt(pow.E2(b) + pow.E2(h-v))
		}
		F = func(v float64) float64 {
			return -EA0*(h-v)/l(v)*(l(v)-l(0))/l(0) + k*v
		}
		dFdv = func(v float64) float64 {
			return (EA0/l(v))*pow.E2((h-v)/l(v)) + k + (EA0/l(v))*(l(v)-l(0))/l(0)
		}
	)

	// #############################
	// # Newton-Raphson iterations #
	// #############################
	var (
		// #Initialize
		v    = 0.0
		Dv   = 0.0
		Fext = 0.0

		DFext = DF

		//output = [2]float64{} // [ [0.,0.] ]
	)
	// #Load step iterator
	for i := 0; i < N; i++ {

		fmt.Println("=================================")
		fmt.Println(" Load step ", i)
		fmt.Println("=================================")
		fmt.Println("  NR iter : |Fext-F(v)|")

		//   #####################################
		//   # Compute the new external force    #
		//   #####################################

		Fext = Fext + DFext

		//   #Initialize Newton-Raphson iteration parameters
		error := 1.
		iiter := 0

		//   #############################################
		//   # Compute the derivative of F w.r.t v       #
		//   #############################################
		//
		for error > tol {

			// ########################################
			// # Solve for dv                         #
			// ########################################

			dv := (1. / dFdv(v+Dv)) * (Fext - F(v+Dv))

			// ############################################
			// # Update Delta v                           #
			// ############################################

			Dv += dv

			// ###############################################
			// # Convergence check                           #
			// ###############################################

			error = math.Abs(Fext - F(v+Dv))

			// #Increment the Newton-Raphson iteration counter
			iiter += 1

			fmt.Println("  Iter", iiter, ":", error)

			if iiter == iterMax {
				panic("Newton-Raphson iterations did not converge!")
			}
		}
		//   #Update the displacement
		v += Dv
		Dv = 0.

		//   #Store the output
		//   output.append( [ v, F(v) ] )

		fmt.Println("=================================")

	}

	// Output:
	// =================================
	//  Load step  0
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.8208923633677614
	//   Iter 2 : 0.0027207967150388868
	//   Iter 3 : 6.124807327978488e-09
	// =================================
	// =================================
	//  Load step  1
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.0270042820579874
	//   Iter 2 : 0.003802915631013093
	//   Iter 3 : 1.3494656059265253e-08
	// =================================
	// =================================
	//  Load step  2
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.283083876008277
	//   Iter 2 : 0.005522649763861409
	//   Iter 3 : 3.256189984313096e-08
	// =================================
	// =================================
	//  Load step  3
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.6087420197658844
	//   Iter 2 : 0.008407965001822504
	//   Iter 3 : 8.821660912872176e-08
	// =================================
	// =================================
	//  Load step  4
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 3.034541096475408
	//   Iter 2 : 0.013581270624683839
	//   Iter 3 : 2.758210939646233e-07
	// =================================
	// =================================
	//  Load step  5
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 3.609663130881586
	//   Iter 2 : 0.023639384102295935
	//   Iter 3 : 1.0341175311623374e-06
	//   Iter 4 : 2.148681232938543e-11
	// =================================
	// =================================
	//  Load step  6
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 4.413996039933863
	//   Iter 2 : 0.04510680430615821
	//   Iter 3 : 4.851872859035211e-06
	//   Iter 4 : 3.694822225952521e-12
	// =================================
	// =================================
	//  Load step  7
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 5.5630277251234475
	//   Iter 2 : 0.09439105600313269
	//   Iter 3 : 2.839626375816806e-05
	//   Iter 4 : 1.1937117960769683e-12
	// =================================
	// =================================
	//  Load step  8
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 7.054378323813808
	//   Iter 2 : 0.184999205341569
	//   Iter 3 : 0.00013138432450432447
	//   Iter 4 : 6.707523425575346e-11
	// =================================
	// =================================
	//  Load step  9
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 6.886749237614481
	//   Iter 2 : 0.03027570229369303
	//   Iter 3 : 2.606725502118934e-09
	// =================================
	// =================================
	//  Load step  10
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 5.870052046437081
	//   Iter 2 : 0.1288739426304346
	//   Iter 3 : 6.377252452693938e-05
	//   Iter 4 : 9.663381206337363e-12
	// =================================
	// =================================
	//  Load step  11
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 12.319543741894222
	//   Iter 2 : 0.4391477443053873
	//   Iter 3 : 0.0006129179603249213
	//   Iter 4 : 1.1950760381296277e-09
	// =================================
	// =================================
	//  Load step  12
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 8.892493360770686
	//   Iter 2 : 0.1777364480263941
	//   Iter 3 : 7.526349077124905e-05
	//   Iter 4 : 3.410605131648481e-12
	// =================================
	// =================================
	//  Load step  13
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 6.3635068222432665
	//   Iter 2 : 0.07237730037957135
	//   Iter 3 : 9.691210152595886e-06
	//   Iter 4 : 2.489741746103391e-11
	// =================================
	// =================================
	//  Load step  14
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 4.839525283068838
	//   Iter 2 : 0.03426188753610404
	//   Iter 3 : 1.755240077727649e-06
	//   Iter 4 : 1.8189894035458565e-12
	// =================================
	// =================================
	//  Load step  15
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 3.867610923692496
	//   Iter 2 : 0.018391142604400557
	//   Iter 3 : 4.221190010866849e-07
	// =================================
	// =================================
	//  Load step  16
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 3.205486569639561
	//   Iter 2 : 0.010853126303345562
	//   Iter 3 : 1.2571865681820782e-07
	// =================================
	// =================================
	//  Load step  17
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.7294574825052678
	//   Iter 2 : 0.006881196905737852
	//   Iter 3 : 4.41245902038645e-08
	// =================================
	// =================================
	//  Load step  18
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.3724458494879173
	//   Iter 2 : 0.004612037787410372
	//   Iter 3 : 1.752334810589673e-08
	// =================================
	// =================================
	//  Load step  19
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 2.0955989949522973
	//   Iter 2 : 0.0032301689388987143
	//   Iter 3 : 7.687162906222511e-09
	// =================================
	// =================================
	//  Load step  20
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.8750774086065576
	//   Iter 2 : 0.00234427017676353
	//   Iter 3 : 3.664581527118571e-09
	// =================================
	// =================================
	//  Load step  21
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.695527465413761
	//   Iter 2 : 0.0017519233599614381
	//   Iter 3 : 1.9131221051793545e-09
	// =================================
	// =================================
	//  Load step  22
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.5466515518228334
	//   Iter 2 : 0.0013417429615856236
	//   Iter 3 : 1.03273123386316e-09
	// =================================
	// =================================
	//  Load step  23
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.421303065434813
	//   Iter 2 : 0.0010491882567293942
	//   Iter 3 : 5.561560101341456e-10
	// =================================
	// =================================
	//  Load step  24
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.3143760495863717
	//   Iter 2 : 0.0008351931958259229
	//   Iter 3 : 3.637978807091713e-10
	// =================================
	// =================================
	//  Load step  25
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.2221304108693403
	//   Iter 2 : 0.0006752118272288499
	//   Iter 3 : 1.6757439880166203e-10
	// =================================
	// =================================
	//  Load step  26
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.1417667318487474
	//   Iter 2 : 0.00055331525800284
	//   Iter 3 : 1.2846612662542611e-10
	// =================================
	// =================================
	//  Load step  27
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.0711497659144698
	//   Iter 2 : 0.0004588717497426842
	//   Iter 3 : 6.343725544866174e-11
	// =================================
	// =================================
	//  Load step  28
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 1.0086235755818507
	//   Iter 2 : 0.0003846068923394341
	//   Iter 3 : 5.88897819397971e-11
	// =================================
	// =================================
	//  Load step  29
	// =================================
	//   NR iter : |Fext-F(v)|
	//   Iter 1 : 0.9528848797581304
	//   Iter 2 : 0.0003254332532378612
	//   Iter 3 : 5.206857167650014e-11
	// =================================
}
